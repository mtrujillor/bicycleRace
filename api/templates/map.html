<!DOCTYPE html>
<html>
<head>
<title>       </title>
</head>
<body>
	<nav class="navbar navbar-default">
	  <div class="container">
	    <div class="navbar-header">
	      <a class="navbar-brand" href="#">
	        CICLOVIA TESTAPP
	      </a>
	    </div>
	  </div>
	</nav>
	<div class="container">
		<div class="col-sm-6" style="height:700px">
		    <div id="mapOrigin" class="well"></div>
		</div>
		<div class="col-sm-6">
				<!-- Filters -->
		    
				<!-- Statistics -->
				<div class="col-sm-12" style="padding:0%">
					<div class="panel-group" id="accordion">
				    <div class="panel panel-default" id="panel1">
				      <div class="panel-heading">
					      <span data-toggle="collapse" data-target="#collapseOne" href="#collapseOne" class="collapsed" style="cursor:pointer">
					        <h3 style="margin:0%">
						        Filtros
						      </h3>
				        </span>
			        </div>
				      <div id="collapseOne" class="panel-collapse collapse">
				        <div class="panel-body">
				        	<form role="form" class="col-sm-12" style="padding:0%">
									  <div class="col-sm-6">
									  	<div class="form-group">
										    <label for="age_start">Edad mínima:</label>
										    <input type="number" class="form-control" name="age_start" id="age_start" value=0>
										  </div>
										  <div class="form-group">
										  	<label for="datetimepicker1">Fecha mínima:</label>
					              <div class='input-group date' id='datetimepicker1'>
					                <input type='text' name="date_start" class="form-control" value="10/05/2015 7:00" />
					                <span class="input-group-addon">
					                  <span class="glyphicon glyphicon-calendar"></span>
					                </span>
					              </div>
					            </div>
										  <div class="form-group">
										    <label for="activity">Actividad:</label>
										    <select class="form-control" name="activity" id="activity">
										    	<option value="">Todos</option>
												  <option value="bike riding">Bicicleta</option>
												  <option value="jogging">Trote</option>
												  <option value="walking">Caminata</option>
												  <option value="skating">Patines</option>
												  <option value="other">Otros</option>
												</select>
										  </div>
										  <div class="form-group">
										    <label for="gender">Género:</label>
										    <select class="form-control" name="gender" id="gender">
										    	<option value="">N/A</option>
												  <option value="male">Hombre</option>
												  <option value="female">Mujer</option>
												</select>
										  </div>
									  </div>
									  <div class="col-sm-6">
										  <div class="form-group">
										    <label for="age_end">Edad máxima:</label>
										    <input type="number" class="form-control" name="age_end" id="age_end" value=90>
										  </div>
										  <div class="form-group">
										  	<label for="datetimepicker2">Fecha máxima:</label>
					              <div class='input-group date' id='datetimepicker2'>
					                <input type='text' name="date_end" class="form-control" value="10/05/2015 14:00" />
					                <span class="input-group-addon">
					                  <span class="glyphicon glyphicon-calendar"></span>
					                </span>
					              </div>
					            </div>
					            <div class="form-group">
										    <label for="healthRisk">Problemas de Salud:</label>
										    <select class="form-control" name="healthRisk" id="healthRisk">
										    	<option value="">Todos</option>
												  <option value="cardiovascular">Cardiovascular</option>
												  <option value="breathing">Respiratorio</option>
												  <option value="infectious">Infeccioso</option>
												  <option value="bones joints muscles">Huesos, articulaciones y músculos</option>
												  <option value="other">Otros</option>
												</select>
										  </div>
										</div>
										<div class="col-sm-12">
											<button type="submit" class="btn btn-default">Submit</button>
										</div>
									</form>
				        </div>
				    	</div>
				    </div>
				    <div class="panel panel-default" id="panel2">
				      <div class="panel-heading">
					      <span data-toggle="collapse" data-target="#collapseTwo" href="#collapseTwo" class="collapsed" style="cursor:pointer">
					        <h3 style="margin:0%">
						        Estadísticas
						      </h3>
				        </span>
			        </div>
				      <div id="collapseTwo" class="panel-collapse collapse in">
				        <div class="panel-body">
					        <div class="row" style="border-bottom: 1px solid #DFD7CA">
					        	<div class="col-sm-6">
					        		<h5>Tiempos</h5>
					        		<label>Tiempo promedio de estadía:</label> <div id="tProm">00:00</div>
											<label>Tiempo promedio en Bicicleta:</label> <div id="tPromBic">00:00</div>
											<label>Tiempo promedio en Trote:</label> <div id="tPromTro">00:00</div>
											<label>Tiempo promedio en Caminata:</label> <div id="tPromCam">00:00</div>
											<label>Tiempo promedio en Patines:</label> <div id="tPromPat">00:00</div>
											<label>Tiempo promedio en Otros:</label> <div id="tPromOtr">00:00</div>
										</div>
										<div class="col-sm-6">
											<h5>Participantes por actividad</h5>
					        		<label>Participantes:</label> <div id="numPart">0</div>
											<label>Participantes en Bicicleta:</label> <div id="numBic">0</div>
											<label>Participantes en Trote:</label> <div id="numTro">0</div>
											<label>Participantes en Caminata:</label> <div id="numCam">0</div>
											<label>Participantes en Patines:</label> <div id="numPat">0</div>
											<label>Participantes en Otros:</label> <div id="numOtrAct">0</div>
										</div>
					        	<br>
					        </div>
					        <div class="row">
					        	<div class="col-sm-6">
					        		<h5>Participantes por riesgos de salud</h5>
					        		<label>Participantes:</label> <div id="numPartSal">0</div>
											<label>Cardiovascular:</label> <div id="numCard">0</div>
											<label>Respiratorio:</label> <div id="numResp">0</div>
											<label>Infeccioso:</label> <div id="numInf">0</div>
											<label>Huesos, articulaciones y músculos:</label> <div id="numHAM">0</div>
											<label>Otros:</label> <div id="numOtrSalud">0</div>
										</div>
					        </div>
				        </div>
				      </div>
				    </div>
				  </div>
				</div>
				

		</div>
  </div>

<link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.4/sandstone/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.7.14/css/bootstrap-datetimepicker.css" />
<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDY0kkJiTPVd2U7aTOAwhc9ySH6oHxOIYM&sensor=false"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.2/moment-with-locales.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.7.14/js/bootstrap-datetimepicker.min.js"></script>
<script type="text/javascript">
            $(function () {
                $('#datetimepicker1').datetimepicker({
                    locale: 'es'
                });
                $('#datetimepicker2').datetimepicker({
                    locale: 'es'
                });
            });
        </script>
<script>

    //Google maps
    var initialize;
    initialize = function() {
        infowindow = new google.maps.InfoWindow();
        var latlngOrigin = new google.maps.LatLng(4.714179, -74.032584);

        var originProp = {
            disableDefaultUI: true,
            zoomControl: true,
            zoomControlOptions: {
                style: google.maps.ZoomControlStyle.DEFAULT,
                position: google.maps.ControlPosition.RIGHT_TOP
            },
            center: latlngOrigin,
            zoom: 15,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        var mapOrigin = new google.maps.Map(document.getElementById("mapOrigin"), originProp);
        $("#mapTab").on('shown.bs.tab', function() {

            /* Trigger map resize event */
            google.maps.event.trigger(mapOrigin, 'resize');
            mapOrigin.setCenter(latlngOrigin);
        });

        $("#mapOrigin").css("width", '100%').css("height", '100%');

        var json = getFilteredUsers();
        var locs = 0;
        for (var i = 0; i < json.length; i++) {
            var user = json[i];
            var id = user['_id']['$oid'];
            var locations = user['locations'];
            var color = getRandomColor();
            for (var j = 0; j < locations.length; j++) {
            	var coordinates = locations[j]['coordinates']['coordinates'];
            	var date = new Date(locations[j]['createdAt']['$date']);
            	var latLng = new google.maps.LatLng(coordinates[0],coordinates[1]);
            	var markerOrigin = new google.maps.Marker({
		            position: latLng,
		            map: mapOrigin,
		            draggable:false,
		            icon: pinSymbol(color),
		            title: 'Date: '+date.toUTCString()
		        });
            }
            var events = user['happends'];
            for (var j = 0; j < events.length; j++) {
            	var coordinates = events[j]['coordinates']['coordinates'];
            	var date = new Date(events[j]['createdAt']['$date']);
            	var latLng = new google.maps.LatLng(coordinates[0],coordinates[1]);
            	var name = events[j]['name'];
            	var type = events[j]['type'];
            	var description = events[j]['description'];
            	var icon = 'http://google-maps-icons.googlecode.com/files/accident.png';
            	if(type == 'service')
            		icon = 'http://google-maps-icons.googlecode.com/files/carrepair.png'

            	var marker = new google.maps.Marker({
		            position: latLng,
		            map: mapOrigin,
		            draggable:false,
		            icon: icon,
		            title: name+'\n'+description+'\nDate: '+date.toUTCString()
		        	});
            }
        }

        populateActivityData();
        populateHealthData();

        function getRandomColor() {
		    var letters = '0123456789ABCDEF'.split('');
		    var color = '#';
		    for (var i = 0; i < 6; i++ ) {
		        color += letters[Math.floor(Math.random() * 16)];
		    }
		    return color;
		}

        
        function pinSymbol(color) {
            return {
                path: 'M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z',
                fillColor: color,
                fillOpacity: 1,
                strokeColor: '#000',
                strokeWeight: 2,
                scale: 1
            };
        }

    }

    function getFilteredUsers() {
        return JSON.parse(getUsers(qs));
    }

    function populateActivityData(){

    	var json = getFilteredUsers();
      document.getElementById("tProm").innerHTML = get_prom_from_list(json)
      document.getElementById("numPart").innerHTML = json.length

      /*Check bike riding*/
      var params = JSON.parse(JSON.stringify(qs));
      if(params['activity'] && !(params['activity'] == 'bike riding')){
      	json = []
      }
      else{
      	params['activity'] = 'bike riding'
      	json = JSON.parse(getUsers(params));
      }
      document.getElementById("tPromBic").innerHTML = get_prom_from_list(json)
      document.getElementById("numBic").innerHTML = json.length

      /*Check jogging*/
      params = JSON.parse(JSON.stringify(qs));
      if(params['activity'] && !(params['activity'] == 'jogging')){
      	json = []
      }
      else{
      	params['activity'] = 'jogging'
      	json = JSON.parse(getUsers(params));
      }
      document.getElementById("tPromTro").innerHTML = get_prom_from_list(json)
      document.getElementById("numTro").innerHTML = json.length

      /*Check walking*/
      params = JSON.parse(JSON.stringify(qs));
      if(params['activity'] && !(params['activity'] == 'walking')){
      	json = []
      }
      else{
      	params['activity'] = 'walking'
      	json = JSON.parse(getUsers(params));
      }
      document.getElementById("tPromCam").innerHTML = get_prom_from_list(json)
      document.getElementById("numCam").innerHTML = json.length

      /*Check skating*/
      params = JSON.parse(JSON.stringify(qs));
      if(params['activity'] && !(params['activity'] == 'skating')){
      	json = []
      }
      else{
      	params['activity'] = 'skating'
      	json = JSON.parse(getUsers(params));
      }
      document.getElementById("tPromPat").innerHTML = get_prom_from_list(json)
      document.getElementById("numPat").innerHTML = json.length

      /*Check other*/
      params = JSON.parse(JSON.stringify(qs));
      if(params['activity'] && !(params['activity'] == 'other')){
      	json = []
      }
      else{
      	params['activity'] = 'other'
      	json = JSON.parse(getUsers(params));
      }
      document.getElementById("tPromOtr").innerHTML = get_prom_from_list(json)
      document.getElementById("numOtrAct").innerHTML = json.length
    }

    function populateHealthData(){
    	
    	var numTot = 0;
    	var numCard = 0;
    	var numResp = 0;
    	var numInf = 0;
    	var numHAM = 0;
    	var numOtrSalud = 0;
    	var json = getFilteredUsers();

    	for (var i = 0; i < json.length; i++){
    		var user = json[i];
    		if(user['healthRisk']){
	    		if(user['healthRisk'] == 'cardiovascular')
	    			numCard++;
	    		else if(user['healthRisk'] == 'breathing')
	    			numResp++;
	    		else if(user['healthRisk'] == 'bones joints muscles')
	    			numHAM++;
	    		else if(user['healthRisk'] == 'infectious')
	    			numInf++;
	    		else if(user['healthRisk'] == 'other')
	    			numOtrSalud++;
	    		numTot++;
	    	}
    	}
    	document.getElementById("numPartSal").innerHTML = numTot
    	document.getElementById("numCard").innerHTML = numCard
    	document.getElementById("numResp").innerHTML = numResp
    	document.getElementById("numInf").innerHTML = numInf
    	document.getElementById("numHAM").innerHTML = numHAM
    	document.getElementById("numOtrSalud").innerHTML = numOtrSalud

    }

    function get_prom_from_list(users){
    	var tProm=0;

    	for (var i = 0; i < users.length; i++) {
        var user = users[i];
        var locations = user['locations'];

        var t_min = new Date(locations[0]['createdAt']['$date'])
        var t_max = new Date(locations[0]['createdAt']['$date'])
        
        for (var j = 1; j < locations.length; j++) {
        	var date = new Date(locations[j]['createdAt']['$date']);
        	if(date < t_min)
        		t_min = date
        	if(date > t_max)
        		t_max = date
        }

        tProm += (t_max - t_min)
      }
      if(users.length > 0){
      	tProm = tProm/users.length
      	tPromDate = new Date(tProm)
      	return tPromDate.getUTCHours()+":"+tPromDate.getUTCMinutes()+":"+tPromDate.getUTCSeconds();
      }
      else
      	return "0:00:00"
    }

    /*Grab the website parameters*/
    var qs = (function(a) {
	    if (a == "") return {};
	    var b = {};
	    for (var i = 0; i < a.length; ++i)
	    {
	        var p=a[i].split('=', 2);
	        if (p.length == 1)
	            b[p[0]] = "";
	        else
	            b[p[0]] = decodeURIComponent(p[1].replace(/\+/g, " "));
	    }
	    return b;
		})(window.location.search.substr(1).split('&'));

		/*Get information for a workspace*/
    function getUsers(params) {
        return $.ajax({
          type: "GET",
          async:false,
          dataType: "json",
          url: "/users",
          dataType: "JSON",
          data: params,
        }).responseText;
    }

    google.maps.event.addDomListener(window, 'load', initialize);

</script>
</body>
</html>